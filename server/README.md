# 上传组件服务端

服务端使用 express 框架实现



## 思路

### 接受切片

1. 接受客户端发送的`from`表单
2. 使用`fromidable`进行解析，得到文件切片的`hash`值以及文件名
3. 将该切片存在以当前文件名作为文件夹名，hash值作为文件名下

> 实际单个切片的文件名是其文件的hash值，hash值是文件的hash值+切片的下标,  目的是为了用户在修改了文件名之后依然可以实现秒传



### 合并切片

1. 解析请求，得到待合并的文件名，每个切片大小
2. 通过`node`原生模块`fs`的管道流异步的将每一个切片以特定位置输入到新文件中（假设当前切片为第二个切片，每个切片大小为4M,那么起始位置就为2 * 1024 * 1024 * 1）
3. 将每个异步任务做成一个Promise数组， 使用`await Promise.all`方法等待所有流输入完成后删除文件夹，



### 验证文件信息

1. 解析请求得到文件名
2. 判断该文件是否存在，若存在直接返回对应的`url`
3. 若不存在则去判断该文件夹是否存在，异步的读取文件夹中所有的文件，并下发给前端，用于断点续传





