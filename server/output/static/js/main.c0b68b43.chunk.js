(this["webpackJsonpupload-component"]=this["webpackJsonpupload-component"]||[]).push([[0],{11:function(e,t,a){e.exports=a(18)},16:function(e,t,a){},18:function(e,t,a){"use strict";a.r(t);var n=a(0),i=a.n(n),l=a(7),r=a.n(l),o=(a(16),a(4)),s=a(5),c=a(3),u=a(9),d=a(10),p=a(1),h=a.n(p),f=a(2);function m(e,t){for(var a=[],n=0,i=1;n<e.size;)a.push({file:e.slice(n,n+t),hash:"".concat(e.name,"_").concat(i),fileName:e.name}),i++,n+=t;return a}var v=a(8),F=a.n(v),y=function(e){return new Promise((function(t){var a=new F.a.ArrayBuffer,n=0;!function i(l){var r=new FileReader;r.readAsArrayBuffer(e[l].file),r.onload=function(l){n++,a.append(l.target.result),n!==e.length?i(n):t(a.end())}}(0)}))},g="http://127.0.0.1:8001/",w={sendChunkRequest:g+"file_upload",mergeRequest:g+"mergeReq",verify:g+"verify"};function b(e,t,a){return k.apply(this,arguments)}function k(){return(k=Object(f.a)(h.a.mark((function e(t,a,n){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,i){for(var l=t.chunkList,r=l.length,o=0,s=!1,c=function(){var a=Object(f.a)(h.a.mark((function a(){var u,d,p,f;return h.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(!s){a.next=2;break}return a.abrupt("return");case 2:(u=l.shift())&&((d=new FormData).append("fileData",u.file),d.append("fileName",u.fileName),d.append("hash",u.hash),p=new XMLHttpRequest,f=u.index,p.onerror=function(e){s=!0,i(e)},p.onload=function(){(p.status<200||p.status>=300)&&(s=!0,i("\u670d\u52a1\u7aef\u8fd4\u56de\u72b6\u6001\u7801\u9519\u8bef")),o===r-1?e():(o++,c())},p.upload&&(p.upload.onprogress=function(e){e.total>0&&(e.percent=e.loaded/e.total*100),n(t.id,e,f)}),p.open("post",w.sendChunkRequest,!0),p.send(d));case 4:case"end":return a.stop()}}),a)})));return function(){return a.apply(this,arguments)}}();a>0;)setTimeout((function(){c()}),100*Math.random()),a--})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e){var t=e.url,a=e.data||null,n=e.method||"post",i=e.headers||{};return new Promise((function(e){var l=new XMLHttpRequest;l.open(n,t),Object.keys(i).forEach((function(e){l.setRequestHeader(e,i[e])})),l.onreadystatechange=function(){4===l.readyState&&(l.status>=200&&l.status<=300||304===l.status)&&e({data:l.responseText})},l.send(a)}))}function U(e,t){for(var a=0,n=t.length;a<n;a++)if(t[a].id===e)return a;return-1}var C=function(){function e(t){Object(o.a)(this,e),this.waitCalculateFiles=[],this.waitUploadFiles=[],this.uploadedFiles=[],this.updateWaitCalculateFile=void 0,this.updateWaitUploadFile=void 0,this.updateUploadedFiles=void 0,this.isCalculating=void 0,this.chunkSize=void 0,this.chunksConcurrenceUploadNum=void 0,this.concurrency=void 0,this.isCalculating=!1,this.chunkSize=t.chunkSize?t.chunkSize:4194304,this.concurrency=t.concurrency?t.concurrency:3,this.updateWaitCalculateFile=t.updateWaitCalculateFile,this.updateWaitUploadFile=t.updateWaitUploadFile,this.updateUploadedFiles=t.updateUploadedFiles,this.chunksConcurrenceUploadNum=parseInt(String(10/this.waitUploadFiles.length))}return Object(s.a)(e,[{key:"addNewFiles",value:function(e){for(var t=0,a=e.length;t<a;t++)this.waitCalculateFiles.push({id:"".concat(e[t].name,"_").concat((new Date).getTime()),file:e[t]});this.updateWaitCalculateFile(this.waitCalculateFiles),this.calculateFilesMessage()}},{key:"calculateFilesMessage",value:function(){var e=Object(f.a)(h.a.mark((function e(){var t,a=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=h.a.mark((function e(){var t,n,i;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.waitCalculateFiles[0].file,n={id:"".concat(t.name,"_").concat((new Date).getTime()),file:t,chunkList:m(t,a.chunkSize),uploadProcess:0,uploadPercentArr:[],uploadedSize:0},e.next=4,y(n.chunkList);case 4:i=e.sent,n.hash=i,console.info(i),a.waitCalculateFiles.shift(),n.chunkList.forEach((function(e,t){e.hash="".concat(i,"_").concat(t),e.index=t,e.fileName=i})),n.uploadPercentArr=new Array(n.chunkList.length).fill(0),a.addCalculatedFile(n),a.updateWaitCalculateFile(a.waitCalculateFiles);case 12:case"end":return e.stop()}}),e)}));case 1:if(!(this.waitCalculateFiles.length>0)){e.next=5;break}return e.delegateYield(t(),"t0",3);case 3:e.next=1;break;case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"addUploadedFiles",value:function(e,t){this.uploadedFiles.push({fileName:e,url:t}),this.updateUploadedFiles(this.uploadedFiles)}},{key:"addCalculatedFile",value:function(){var e=Object(f.a)(h.a.mark((function e(t){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.waitUploadFiles.push(t),this.updateWaitUploadFile(this.waitUploadFiles),this.upload(t);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"upload",value:function(){var e=Object(f.a)(h.a.mark((function e(t){var a,n,i,l=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.verifyRequest(t.file.name,t.hash);case 2:if(a=e.sent,1!==(a=JSON.parse(a.data)).status){e.next=7;break}return this.completeFileUpload(t.id,t.file.name,a.url),e.abrupt("return");case 7:if(!a.AlreadyUploadList){e.next=14;break}if(n=this.calculeateAlreadyUploadSize(a.AlreadyUploadList,t),-1!==(i=U(t.id,this.waitUploadFiles))){e.next=12;break}return e.abrupt("return");case 12:this.waitUploadFiles[i].uploadedSize=n,this.waitUploadFiles[i].chunkList=this.waitUploadFiles[i].chunkList.filter((function(e){return-1===a.AlreadyUploadList.indexOf(e.hash)}));case 14:b(t,this.concurrency,this.updateUploadFilePercent.bind(this)).then(function(){var e=Object(f.a)(h.a.mark((function e(a){var n;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.mergeRequest(t);case 2:n=e.sent,n=JSON.parse(n.data),l.completeFileUpload(t.id,t.file.name,n.url);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"calculeateAlreadyUploadSize",value:function(e,t){for(var a=0,n=0,i=e.length;n<i;n++){var l=e[n].slice(-1);a+=t.chunkList[l].file.size}return a}},{key:"completeFileUpload",value:function(e,t,a){var n=U(e,this.waitUploadFiles);this.waitUploadFiles.splice(n,n+1),this.updateWaitUploadFile(this.waitUploadFiles),this.addUploadedFiles(t,a)}},{key:"verifyRequest",value:function(e,t){return x({method:"post",url:w.verify,headers:{"content-type":"application/json"},data:JSON.stringify({fileName:e,fileHash:t})})}},{key:"updateUploadFilePercent",value:function(e,t,a){var n=U(e,this.waitUploadFiles);-1!==n&&(this.waitUploadFiles[n].uploadPercentArr[a]=t.loaded,this.waitUploadFiles[n].uploadProcess=function(e,t){var a=e;return t.uploadPercentArr.forEach((function(e){a+=e})),a/t.file.size}(this.waitUploadFiles[n].uploadedSize,this.waitUploadFiles[n]),this.updateWaitUploadFile(this.waitUploadFiles))}},{key:"mergeRequest",value:function(e){return x({method:"post",url:w.mergeRequest,headers:{"content-type":"application/json"},data:JSON.stringify({fileName:e.hash,newname:"".concat(e.hash,".").concat((t=e.file.name,t.split(".")[t.split(".").length-1])),size:e.file.size,chunkSize:this.chunkSize})});var t}}]),e}(),E=function(e){var t=e.files.map((function(e){return i.a.createElement("li",{key:e.id},e.file.name)}));return i.a.createElement("div",{style:{width:"400px",margin:"auto",borderRadius:"10px",textAlign:"center",color:"blue",padding:"10px",border:"1px solid #5099ed",backgroundColor:"#b8d7fb",display:"".concat(e.files.length>0?"block":"none")}},i.a.createElement("p",null,"\u6b63\u5728\u8ba1\u7b97\u4ee5\u4e0b\u6587\u4ef6\u54c8\u5e0c\uff0c\u8bf7\u7a0d\u7b49"),i.a.createElement("ul",{style:{listStyle:"none",padding:"0px"}},t))};function S(e){return i.a.createElement("div",{style:{width:"400px",border:"2px solid gray",borderStyle:"dashed",borderRadius:"2%",position:"relative",backgroundColor:"#f9f9f9",margin:"100px auto 20px auto",backgroundImage:'url("http://49.234.79.241:8001/ddad1a4c0164ed53590ffeb51d0a1a72.png")',backgroundSize:"cover"}},i.a.createElement("input",{style:{width:"400px",height:"200px",opacity:"0"},type:"file",onChange:e.handleFileChange,multiple:!0}))}var O=function(e){for(var t=e.uploadProcess;t>=1.1;)t/=10;return i.a.createElement("div",{style:{width:"100%",height:"5px",backgroundColor:"#c9c9c9",borderRadius:"4px",overflow:"hidden"}},i.a.createElement("div",{style:{width:"".concat(100*t,"%"),height:"5px",backgroundImage:"linear-gradient(to right, #8ebeb9, #3bc9d7, #37b9e9)",transition:"all .5s"}}))};var z=function(e){return i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{style:{float:"left",fontSize:"15px",color:"#719dec"}},e.waitUploadFile.file.name),i.a.createElement("div",{style:{content:"",display:"block",clear:"both"}}),i.a.createElement("div",{style:{marginBottom:"5px"}},i.a.createElement(O,{uploadProcess:e.waitUploadFile.uploadProcess})))};function j(e){var t=e.waitUploadFiles.map((function(e,t){return i.a.createElement("li",{key:e.id},i.a.createElement(z,{waitUploadFile:e}))}));return i.a.createElement("div",{style:{width:"400px",margin:"auto",borderRadius:"10px",textAlign:"center",color:"blue",padding:"10px",border:"1px solid #5099ed",backgroundColor:"#fff",marginTop:"20px",transition:"all 1s",display:"".concat(e.waitUploadFiles.length>0?"block":"none")}},i.a.createElement("ul",{style:{padding:"0px",listStyle:"none"}},t))}var A=function(e){var t=e.text,a=void 0===t?"":t,n=e.color,l=void 0===n?"#e7cfcf":n,r=e.lineColor,o=void 0===r?"#e7cfcf":r,s=e.margin,c=void 0===s?"10px":s;return i.a.createElement("div",{style:{display:"flex",alignItems:"center"}},i.a.createElement("span",{style:{flexGrow:1,borderBottom:"1px solid ".concat(o)}}),i.a.createElement("div",{style:{margin:"0 ".concat(c),color:l}},a),i.a.createElement("span",{style:{flexGrow:1,borderBottom:"1px solid ".concat(o)}}))},R=function(e){var t=e.uploadedFiles.map((function(e,t){return i.a.createElement("li",{key:t,style:{marginBottom:"10px"}},i.a.createElement("div",null,e.fileName),i.a.createElement("a",{href:e.url},e.url))}));return i.a.createElement("div",{style:{width:"500px",margin:"auto",textAlign:"center",color:"green",padding:"10px",borderTop:"1px solid green",backgroundColor:"#fff",marginTop:"20px",display:"".concat(e.uploadedFiles.length>0?"block":"none")}},i.a.createElement(A,{text:"\u5df2\u4e0a\u4f20\u6587\u4ef6",margin:"30px",color:"green",lineColor:"green"}),i.a.createElement("ul",{style:{padding:"0px",listStyle:"none",listStyleType:"none",display:"flex",flexDirection:"column"}},t))},W=function(e){Object(d.a)(a,e);var t=Object(u.a)(a);function a(){var e;Object(o.a)(this,a);for(var n=arguments.length,i=new Array(n),l=0;l<n;l++)i[l]=arguments[l];return(e=t.call.apply(t,[this].concat(i))).state={waitUploadFiles:[],waitCalculateFiles:[],uploadedFiles:[]},e.uploadClass=new C({chunkSize:4194304,concurrency:4,updateWaitCalculateFile:e.updateWaitCalculateFile.bind(Object(c.a)(e)),updateWaitUploadFile:e.updateWaitUploadFile.bind(Object(c.a)(e)),updateUploadedFiles:e.updateUploadedFiles.bind(Object(c.a)(e))}),e.handleFileChange=function(t){e.uploadClass.addNewFiles(t.target.files)},e}return Object(s.a)(a,[{key:"updateWaitCalculateFile",value:function(e){this.setState({waitCalculateFiles:e})}},{key:"updateWaitUploadFile",value:function(e){this.setState({waitUploadFiles:e})}},{key:"updateUploadedFiles",value:function(e){this.setState({uploadedFiles:e})}},{key:"render",value:function(){return n.createElement(n.Fragment,null,n.createElement(S,{handleFileChange:this.handleFileChange}),n.createElement(E,{files:this.state.waitCalculateFiles}),n.createElement(j,{waitUploadFiles:this.state.waitUploadFiles}),n.createElement(R,{uploadedFiles:this.state.uploadedFiles}))}}]),a}(n.Component);var N=function(){return i.a.createElement(W,null)};r.a.render(i.a.createElement(i.a.StrictMode,null,i.a.createElement(N,null)),document.getElementById("root"))}},[[11,1,2]]]);
//# sourceMappingURL=main.c0b68b43.chunk.js.map